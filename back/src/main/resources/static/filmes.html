<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>SuperStats - Gestão de Filmes (Protegido)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .section { margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">SuperStats - Gestão de Filmes</h1>
        <div>
            <a href="login.html" class="btn btn-secondary">Ir para a Home</a>
            <button class="btn btn-danger" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div class="section">
        <h3>Todos os Filmes</h3>
        <button class="btn btn-primary mb-2" onclick="getAll()">Atualizar Lista</button>
        <table class="table table-striped" id="filmeTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Produtora</th>
                <th>Diretor</th>
                <th>Data de Lançamento</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="section">
        <h3>Buscar Filme por ID</h3>
        <div class="input-group mb-2">
            <input type="number" id="idGet" class="form-control" placeholder="ID do filme">
            <button class="btn btn-info" onclick="getById()">Buscar</button>
        </div>
        <pre id="outputId"></pre>
    </div>

    <div class="section">
        <h3>Buscar Filme por Título</h3>
        <div class="input-group mb-2">
            <input type="text" id="titleGet" class="form-control" placeholder="Título do filme">
            <button class="btn btn-info" onclick="getByTitle()">Buscar</button>
        </div>
        <pre id="outputTitle"></pre>
    </div>

    <div class="section">
        <h3>Buscar Filmes por Produtora</h3>
        <select id="produtoraSelect" class="form-select" onchange="getBySelectedProdutora()">
            <option selected disabled>Carregando produtoras...</option>
        </select>
        <pre id="outputProdutora" class="mt-2"></pre>
    </div>

    <div class="section">
        <h3>Criar Filme</h3>
        <form id="formCreate" onsubmit="createFilme(event)">
            <div class="row mb-2">
                <div class="col"><input type="text" id="tituloPost" class="form-control" placeholder="Título" required></div>
                <div class="col"><input type="text" id="produtoraPost" class="form-control" placeholder="Produtora" required></div>
            </div>
            <div class="row mb-2">
                <div class="col"><input type="text" id="diretorPost" class="form-control" placeholder="Diretor"></div>
                <div class="col"><input type="date" id="dataPost" class="form-control" placeholder="Data de Lançamento"></div>
            </div>
            <button class="btn btn-success w-100" type="submit">Criar</button>
        </form>
        <pre id="outputPost"></pre>
    </div>

    <div class="section">
        <h3>Atualizar Filme</h3>
        <form id="formUpdate" onsubmit="updateFilme(event)">
            <div class="row mb-2">
                <div class="col"><input type="number" id="idPut" class="form-control" placeholder="ID do filme" required></div>
                <div class="col"><input type="text" id="tituloPut" class="form-control" placeholder="Título"></div>
            </div>
            <div class="row mb-2">
                <div class="col"><input type="text" id="produtoraPut" class="form-control" placeholder="Produtora"></div>
                <div class="col"><input type="text" id="diretorPut" class="form-control" placeholder="Diretor"></div>
            </div>
            <div class="row mb-2">
                <div class="col"><input type="date" id="dataPut" class="form-control" placeholder="Data de Lançamento"></div>
            </div>
            <button class="btn btn-warning w-100" type="submit">Atualizar</button>
        </form>
        <pre id="outputPut"></pre>
    </div>

    <div class="section">
        <h3>Deletar Filme</h3>
        <div class="input-group mb-2">
            <input type="number" id="idDel" class="form-control" placeholder="ID do filme">
            <button class="btn btn-danger" onclick="deleteFilme()">Deletar</button>
        </div>
        <pre id="outputDel"></pre>
    </div>
</div>

<script>
    const baseUrl = 'http://localhost:8080/filmes';
    const apiUrl = 'http://localhost:8080';

    // --- LÓGICA DE SEGURANÇA E AUTENTICAÇÃO ---

    // O "GUARDA" DE ACESSO: Roda assim que a página carrega
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            alert("Acesso negado. Por favor, faça o login.");
            window.location.href = 'login.html';
        } else {
            getAll();
            populateProdutorasSelect();
        }
    });

    function handleLogout() {
        localStorage.removeItem('jwtToken');
        window.location.href = 'login.html';
    }

    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('jwtToken');
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            ...options.headers,
        };

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401 || response.status === 403) {
            handleLogout();
            throw new Error('Sessão inválida ou expirada.');
        }

        return response;
    }

    // --- FUNÇÕES DO CRUD (Agora usando fetchWithAuth) ---

    async function getAll() {
        try {
            const res = await fetchWithAuth(baseUrl);
            if (!res.ok) throw new Error("Falha ao carregar filmes");

            const tbody = document.querySelector("#filmeTable tbody");
            if (res.status === 204) { // No Content
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum filme cadastrado.</td></tr>';
                return;
            }

            const data = await res.json();
            tbody.innerHTML = "";

            data.forEach(filme => {
                const tr = document.createElement("tr");
                let dataFormatada = '';
                if (filme.dataLancamento) {
                    const partesData = filme.dataLancamento.split('-');
                    dataFormatada = `${partesData[2]}/${partesData[1]}/${partesData[0]}`;
                }
                tr.innerHTML = `
                    <td>${filme.id}</td>
                    <td>${filme.titulo}</td>
                    <td>${filme.produtora}</td>
                    <td>${filme.diretor || ''}</td>
                    <td>${dataFormatada}</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error("Falha na função getAll:", error);
        }
    }

    async function getById() {
        const id = document.getElementById('idGet').value;
        if (!id) return;
        const res = await fetchWithAuth(`${baseUrl}/${id}`);
        const output = document.getElementById('outputId');
        output.textContent = res.ok ? JSON.stringify(await res.json(), null, 2) : "Filme não encontrado";
    }

    async function getByTitle() {
        const title = document.getElementById('titleGet').value;
        if (!title) return;
        const res = await fetchWithAuth(`${baseUrl}/titulo?titulo=${encodeURIComponent(title)}`);
        const output = document.getElementById('outputTitle');
        output.textContent = res.ok ? JSON.stringify(await res.json(), null, 2) : "Nenhum filme encontrado com esse título.";
    }

    async function populateProdutorasSelect() {
        try {
            const res = await fetchWithAuth(`${apiUrl}/filmes/produtoras`);
            const produtoras = await res.json();
            const select = document.getElementById('produtoraSelect');
            select.innerHTML = '<option selected disabled>Selecione uma produtora...</option>';
            produtoras.forEach(produtora => {
                const option = document.createElement('option');
                option.value = produtora;
                option.textContent = produtora;
                select.appendChild(option);
            });
        } catch (error) {
            console.error("Falha ao carregar produtoras:", error);
        }
    }

    async function getBySelectedProdutora() {
        const produtora = document.getElementById('produtoraSelect').value;
        const res = await fetchWithAuth(`${baseUrl}/produtora?produtora=${encodeURIComponent(produtora)}`);
        const output = document.getElementById('outputProdutora');
        output.textContent = res.ok ? JSON.stringify(await res.json(), null, 2) : "Nenhum filme encontrado para esta produtora.";
    }

    async function createFilme(event) {
        event.preventDefault();
        const filme = {
            titulo: document.getElementById('tituloPost').value,
            produtora: document.getElementById('produtoraPost').value,
            diretor: document.getElementById('diretorPost').value || null,
            dataLancamento: document.getElementById('dataPost').value || null
        };
        const res = await fetchWithAuth(baseUrl, {
            method: 'POST',
            body: JSON.stringify(filme)
        });
        document.getElementById('outputPost').textContent = await res.text();
        if (res.ok) {
            document.getElementById('formCreate').reset();
            getAll();
            populateProdutorasSelect();
        }
    }

    async function updateFilme(event) {
        event.preventDefault();
        const id = document.getElementById('idPut').value;
        if (!id) return;

        const filme = {
            titulo: document.getElementById('tituloPut').value,
            produtora: document.getElementById('produtoraPut').value,
            diretor: document.getElementById('diretorPut').value,
            dataLancamento: document.getElementById('dataPut').value
        };

        // Remove campos vazios para não sobrescrever dados existentes com nada
        Object.keys(filme).forEach(key => filme[key] === '' && delete filme[key]);

        const res = await fetchWithAuth(`${baseUrl}/${id}`, {
            method: 'PUT',
            body: JSON.stringify(filme)
        });
        document.getElementById('outputPut').textContent = await res.text();
        if (res.ok) {
            document.getElementById('formUpdate').reset();
            getAll();
            populateProdutorasSelect();
        }
    }

    async function deleteFilme() {
        const id = document.getElementById('idDel').value;
        if (!id) return;
        if (!confirm(`Tem certeza que deseja deletar o filme com ID ${id}?`)) return;

        const res = await fetchWithAuth(`${baseUrl}/${id}`, { method: 'DELETE' });

        if (res.ok) {
            document.getElementById('outputDel').textContent = "Filme deletado com sucesso.";
            document.getElementById('idDel').value = '';
            getAll();
            populateProdutorasSelect();
        } else {
            document.getElementById('outputDel').textContent = await res.text();
        }
    }
</script>
</body>
</html>