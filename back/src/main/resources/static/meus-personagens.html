<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>SuperStats - Personagens</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .card { margin-bottom: 2rem; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Personagens da Comunidade</h1>
        <div>
            <a href="login.html" class="btn btn-secondary">Ir para a Home</a>
            <button class="btn btn-danger" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><h4>Criar Novo Personagem</h4></div>
        <div class="card-body">
            <form id="formCreate" onsubmit="createPersonagem(event)">
                <div class="row g-3">
                    <div class="col-md-6"><input type="text" id="nomePost" class="form-control" placeholder="Nome do Personagem" required></div>
                    <div class="col-md-6"><input type="text" id="poderPost" class="form-control" placeholder="Poder Principal"></div>
                    <div class="col-md-3"><input type="text" id="alinhamentoPost" class="form-control" placeholder="Alinhamento (Ex: Herói)"></div>
                    <div class="col-md-3"><input type="text" id="generoPost" class="form-control" placeholder="Gênero"></div>
                    <div class="col-md-3"><input type="number" step="0.01" id="alturaPost" class="form-control" placeholder="Altura (metros)"></div>
                    <div class="col-md-3"><input type="number" step="0.01" id="pesoPost" class="form-control" placeholder="Peso (kg)"></div>
                </div>
                <button class="btn btn-success w-100 mt-3" type="submit">Criar Personagem</button>
            </form>
            <pre id="outputPost" class="mt-3"></pre>
        </div>
    </div>

    <ul class="nav nav-tabs" id="personagemTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="todos-tab" data-bs-toggle="tab" data-bs-target="#todos-pane" type="button" role="tab">Todos os Personagens</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="meus-tab" data-bs-toggle="tab" data-bs-target="#meus-pane" type="button" role="tab">Meus Personagens</button>
        </li>
    </ul>

    <div class="tab-content" id="personagemTabContent">
        <div class="tab-pane fade show active" id="todos-pane" role="tabpanel">
            <table class="table table-striped mt-3">
                <thead><tr><th>ID</th><th>Nome</th><th>Poder</th><th>Criador</th><th>Ações</th></tr></thead>
                <tbody id="todosPersonagensTbody"></tbody>
            </table>
        </div>
        <div class="tab-pane fade" id="meus-pane" role="tabpanel">
            <table class="table table-striped mt-3">
                <thead><tr><th>ID</th><th>Nome</th><th>Poder</th><th>Criador</th><th>Ações</th></tr></thead>
                <tbody id="meusPersonagensTbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const baseUrl = 'http://localhost:8080/personagens-novos';

    // --- LÓGICA DE SEGURANÇA (Igual) ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('jwtToken')) {
            window.location.href = 'login.html';
        } else {
            fetchAllPersonagens(); // Carrega a primeira aba por padrão
            fetchMyPersonagens();  // Carrega a segunda aba
        }
    });

    function handleLogout() {
        localStorage.removeItem('jwtToken');
        window.location.href = 'login.html';
    }

    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('jwtToken');
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers };
        const response = await fetch(url, { ...options, headers });
        if (response.status === 401 || response.status === 403) {
            handleLogout();
        }
        return response;
    }

    // --- FUNÇÕES DO CRUD (Refatoradas para abas) ---

    // Função genérica para renderizar dados em uma tabela
    function renderTable(data, tbodyId) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = "";
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum personagem encontrado.</td></tr>';
            return;
        }
        data.forEach(p => {
            const criador = p.faCriador ? p.faCriador.username : 'Desconhecido';
            tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.nome}</td>
                    <td>${p.poder || ''}</td>
                    <td>${criador}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="deletePersonagem(${p.id})">Deletar</button></td>
                </tr>
            `;
        });
    }

    // Busca TODOS os personagens
    async function fetchAllPersonagens() {
        try {
            const res = await fetchWithAuth(baseUrl);
            const data = await res.json();
            renderTable(data, 'todosPersonagensTbody');
        } catch(e) { console.error(e) }
    }

    // Busca apenas MEUS personagens
    async function fetchMyPersonagens() {
        try {
            const res = await fetchWithAuth(`${baseUrl}/meus`); // Novo endpoint
            const data = await res.json();
            renderTable(data, 'meusPersonagensTbody');
        } catch(e) { console.error(e) }
    }

    // Atualiza ambas as listas
    function refreshAllTables() {
        fetchAllPersonagens();
        fetchMyPersonagens();
    }

    async function createPersonagem(event) {
        event.preventDefault();
        const output = document.getElementById('outputPost');
        const dto = {
            nome: document.getElementById('nomePost').value,
            poder: document.getElementById('poderPost').value || null,
            alinhamento: document.getElementById('alinhamentoPost').value || null,
            genero: document.getElementById('generoPost').value || null,
            altura: parseFloat(document.getElementById('alturaPost').value) || null,
            peso: parseFloat(document.getElementById('pesoPost').value) || null
        };

        const res = await fetchWithAuth(baseUrl, { method: 'POST', body: JSON.stringify(dto) });
        output.textContent = await res.text();
        if (res.ok) {
            document.getElementById('formCreate').reset();
            refreshAllTables(); // Atualiza as duas tabelas
        }
    }

    async function deletePersonagem(id) {
        if (!confirm(`Tem certeza que deseja deletar o personagem com ID ${id}? Apenas o criador pode fazer isso.`)) return;

        const res = await fetchWithAuth(`${baseUrl}/${id}`, { method: 'DELETE' });
        if (res.ok) {
            alert('Personagem deletado com sucesso!');
            refreshAllTables(); // Atualiza as duas tabelas
        } else {
            const errorMsg = await res.text();
            alert(`Erro: ${errorMsg}`);
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>