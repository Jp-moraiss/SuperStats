<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>SuperStats - Personagens</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .card { margin-bottom: 2rem; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 1rem; white-space: pre-wrap; }
    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">Personagens da Comunidade</h1>
        <div>
            <a href="login.html" class="btn btn-secondary">Ir para a Home</a>
            <button class="btn btn-danger" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><h4>Criar Novo Personagem</h4></div>
        <div class="card-body">
            <form id="formCreate" onsubmit="createPersonagem(event)">
                <div class="row g-3">
                    <div class="col-md-6"><input type="text" id="nomePost" class="form-control" placeholder="Nome do Personagem" required></div>
                    <div class="col-md-6"><input type="text" id="poderPost" class="form-control" placeholder="Poder Principal"></div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <select class="form-select" id="alinhamentoPost">
                                <option value="" selected>Sem Alinhamento</option>
                                <option value="Herói">Herói</option>
                                <option value="Anti-Herói">Anti-Herói</option>
                                <option value="Vilão">Vilão</option>
                            </select>
                            <label for="alinhamentoPost">Alinhamento</label>
                        </div>
                    </div>
                    <div class="col-md-3"><input type="text" id="generoPost" class="form-control" placeholder="Gênero"></div>
                    <div class="col-md-3"><input type="number" step="0.01" id="alturaPost" class="form-control" placeholder="Altura (metros)"></div>
                    <div class="col-md-3"><input type="number" step="0.01" id="pesoPost" class="form-control" placeholder="Peso (kg)"></div>
                </div>
                <button class="btn btn-success w-100 mt-3" type="submit">Criar Personagem</button>
            </form>
            <pre id="outputPost" class="mt-3"></pre>
        </div>
    </div>

    <div id="updateCard" class="card" style="display: none;">
        <div class="card-header"><h4>Atualizar Personagem</h4></div>
        <div class="card-body">
            <form id="formUpdate" onsubmit="updatePersonagem(event)">
                <input type="hidden" id="idPut">
                <div class="row g-3">
                    <div class="col-md-6"><input type="text" id="nomePut" class="form-control" placeholder="Nome do Personagem" required></div>
                    <div class="col-md-6"><input type="text" id="poderPut" class="form-control" placeholder="Poder Principal"></div>
                    <div class="col-md-3">
                        <div class="form-floating">
                            <select class="form-select" id="alinhamentoPut">
                                <option value="" selected>Sem Alinhamento</option>
                                <option value="Herói">Herói</option>
                                <option value="Anti-Herói">Anti-Herói</option>
                                <option value="Vilão">Vilão</option>
                            </select>
                            <label for="alinhamentoPut">Alinhamento</label>
                        </div>
                    </div>
                    <div class="col-md-3"><input type="text" id="generoPut" class="form-control" placeholder="Gênero"></div>
                    <div class="col-md-3"><input type="number" step="0.01" id="alturaPut" class="form-control" placeholder="Altura (metros)"></div>
                    <div class="col-md-3"><input type="number" step="0.01" id="pesoPut" class="form-control" placeholder="Peso (kg)"></div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-warning w-100" type="submit">Salvar Alterações</button>
                    <button class="btn btn-secondary" type="button" onclick="hideUpdateForm()">Cancelar</button>
                </div>
            </form>
            <pre id="outputPut" class="mt-3"></pre>
        </div>
    </div>

    <div class="card">
        <div class="card-header"><h4>Buscas Específicas e Estatísticas</h4></div>
        <div class="card-body">
            <div class="input-group mb-3">
                <input type="number" id="idGet" class="form-control" placeholder="Buscar Personagem por ID">
                <button class="btn btn-outline-secondary" onclick="getPersonagemById()">Buscar</button>
            </div>
            <div class="input-group mb-3">
                <select class="form-select" id="alinhamentoGet" onchange="getPersonagensByAlinhamento()">
                    <option value="" selected>Filtrar por Alinhamento (Todos)</option>
                    <option value="Herói">Herói</option>
                    <option value="Anti-Herói">Anti-Herói</option>
                    <option value="Vilão">Vilão</option>
                </select>
            </div>
            <button class="btn btn-info" onclick="getEstatisticas()">Ver Contagem por Alinhamento</button>
            <pre id="outputBuscas"></pre>
        </div>
    </div>

    <ul class="nav nav-tabs" id="personagemTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="todos-tab" data-bs-toggle="tab" data-bs-target="#todos-pane" type="button" role="tab">Todos os Personagens</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="meus-tab" data-bs-toggle="tab" data-bs-target="#meus-pane" type="button" role="tab">Meus Personagens</button>
        </li>
    </ul>

    <div class="tab-content" id="personagemTabContent">
        <div class="tab-pane fade show active" id="todos-pane" role="tabpanel">
            <table class="table table-striped table-hover mt-3">
                <thead><tr><th>ID</th><th>Nome</th><th>Poder</th><th>Criador</th><th>Ações</th></tr></thead>
                <tbody id="todosPersonagensTbody"></tbody>
            </table>
        </div>
        <div class="tab-pane fade" id="meus-pane" role="tabpanel">
            <table class="table table-striped table-hover mt-3">
                <thead><tr><th>ID</th><th>Nome</th><th>Poder</th><th>Criador</th><th>Ações</th></tr></thead>
                <tbody id="meusPersonagensTbody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const baseUrl = 'http://localhost:8080/personagens-novos';

    // --- LÓGICA DE SEGURANÇA E INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        if (!localStorage.getItem('jwtToken')) {
            alert("Acesso negado. Por favor, faça o login.");
            window.location.href = 'login.html';
        } else {
            fetchAllPersonagens();
            fetchMyPersonagens();
        }
    });

    function handleLogout() {
        localStorage.removeItem('jwtToken');
        window.location.href = 'login.html';
    }

    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('jwtToken');
        const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers };
        const response = await fetch(url, { ...options, headers });
        if (response.status === 401) { // Apenas 401 desloga
            handleLogout();
        }
        return response;
    }

    // --- FUNÇÕES DE CONSULTA ---
    async function getPersonagemById() {
        const id = document.getElementById('idGet').value;
        const output = document.getElementById('outputBuscas');
        if (!id) {
            output.textContent = 'Por favor, insira um ID.';
            return;
        }
        try {
            const res = await fetchWithAuth(`${baseUrl}/${id}`);
            if (res.ok) {
                const data = await res.json();
                output.textContent = JSON.stringify(data, null, 2);
            } else {
                output.textContent = `Personagem com ID ${id} não encontrado.`;
            }
        } catch(e) {
            output.textContent = 'Erro ao buscar personagem.';
            console.error(e);
        }
    }

    async function getPersonagensByAlinhamento() {
        const alinhamento = document.getElementById('alinhamentoGet').value;
        const output = document.getElementById('outputBuscas');
        if (!alinhamento) {
            output.textContent = 'Filtro de alinhamento removido.';
            return;
        }
        try {
            const res = await fetchWithAuth(`${baseUrl}/alinhamento/${encodeURIComponent(alinhamento)}`);
            if(res.ok) {
                const data = await res.json();
                if (data.length === 0) {
                    output.textContent = `Nenhum personagem encontrado para o alinhamento "${alinhamento}".`;
                } else {
                    output.textContent = JSON.stringify(data, null, 2);
                }
            } else {
                output.textContent = `Nenhum personagem encontrado para o alinhamento "${alinhamento}".`;
            }
        } catch(e) {
            output.textContent = 'Erro ao buscar personagens.';
            console.error(e);
        }
    }

    async function getEstatisticas() {
        const output = document.getElementById('outputBuscas');
        output.textContent = 'Buscando estatísticas...';
        try {
            const res = await fetchWithAuth(`${baseUrl}/estatisticas/contagem-por-alinhamento`);
            if(res.ok) {
                const data = await res.json();
                let formattedText = "Contagem de Personagens por Alinhamento:\n\n";
                if (data.length === 0) {
                    formattedText = "Nenhum personagem com alinhamento definido para gerar estatísticas.";
                } else {
                    data.forEach(item => {
                        formattedText += `- ${item.alinhamento}: ${item.total} personagem(ns)\n`;
                    });
                }
                output.textContent = formattedText;
            } else {
                output.textContent = "Não foi possível carregar as estatísticas.";
            }
        } catch(e) {
            output.textContent = 'Erro ao buscar estatísticas.';
            console.error(e);
        }
    }

    // --- FUNÇÕES DE RENDERIZAÇÃO E CRUD ---
    function renderTable(data, tbodyId, showActions) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = "";
        if (!data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum personagem encontrado.</td></tr>';
            return;
        }
        data.forEach(p => {
            const criador = p.criador ? p.criador.username : 'Desconhecido';
            let acoesHtml = '<td>-</td>';
            if (showActions) {
                acoesHtml = `
                    <td>
                        <button class="btn btn-warning btn-sm me-1" onclick="showUpdateForm(${p.id})">Editar</button>
                        <button class="btn btn-danger btn-sm" onclick="deletePersonagem(${p.id})">Deletar</button>
                    </td>`;
            }
            tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.nome}</td>
                    <td>${p.poder || ''}</td>
                    <td>${criador}</td>
                    ${acoesHtml}
                </tr>
            `;
        });
    }

    async function fetchAllPersonagens() {
        try {
            const res = await fetchWithAuth(baseUrl);
            if (!res.ok) return;
            const data = await res.json();
            renderTable(data, 'todosPersonagensTbody', false);
        } catch(e) { console.error(e) }
    }

    async function fetchMyPersonagens() {
        try {
            const res = await fetchWithAuth(`${baseUrl}/meus`);
            if (!res.ok) return;
            const data = await res.json();
            renderTable(data, 'meusPersonagensTbody', true);
        } catch(e) { console.error(e) }
    }

    function refreshAllTables() {
        fetchAllPersonagens();
        fetchMyPersonagens();
    }

    async function createPersonagem(event) {
        event.preventDefault();
        const output = document.getElementById('outputPost');
        const dto = {
            nome: document.getElementById('nomePost').value,
            poder: document.getElementById('poderPost').value || null,
            alinhamento: document.getElementById('alinhamentoPost').value || null,
            genero: document.getElementById('generoPost').value || null,
            altura: parseFloat(document.getElementById('alturaPost').value) || null,
            peso: parseFloat(document.getElementById('pesoPost').value) || null
        };

        const res = await fetchWithAuth(baseUrl, { method: 'POST', body: JSON.stringify(dto) });
        output.textContent = await res.text();
        if (res.ok) {
            document.getElementById('formCreate').reset();
            refreshAllTables();
        }
    }

    async function deletePersonagem(id) {
        if (!confirm(`Tem certeza que deseja deletar o personagem com ID ${id}? Apenas o criador pode fazer isso.`)) return;

        const res = await fetchWithAuth(`${baseUrl}/${id}`, { method: 'DELETE' });
        if (res.ok) {
            alert('Personagem deletado com sucesso!');
            refreshAllTables();
        } else {
            const errorMsg = await res.text();
            alert(`Erro: ${errorMsg}`);
        }
    }

    // --- FUNÇÕES PARA O UPDATE ---
    function hideUpdateForm() {
        document.getElementById('updateCard').style.display = 'none';
        document.getElementById('formUpdate').reset();
        document.getElementById('outputPut').textContent = '';
    }

    async function showUpdateForm(id) {
        const res = await fetchWithAuth(`${baseUrl}/${id}`);
        if (!res.ok) {
            alert("Não foi possível carregar os dados do personagem para edição.");
            return;
        }
        const personagem = await res.json();

        document.getElementById('idPut').value = personagem.id;
        document.getElementById('nomePut').value = personagem.nome;
        document.getElementById('poderPut').value = personagem.poder;
        document.getElementById('alinhamentoPut').value = personagem.alinhamento;
        document.getElementById('generoPut').value = personagem.genero;
        document.getElementById('alturaPut').value = personagem.altura;
        document.getElementById('pesoPut').value = personagem.peso;

        const updateCard = document.getElementById('updateCard');
        updateCard.style.display = 'block';
        updateCard.scrollIntoView({ behavior: 'smooth' });
    }

    async function updatePersonagem(event) {
        event.preventDefault();
        const id = document.getElementById('idPut').value;
        const output = document.getElementById('outputPut');
        const dto = {
            nome: document.getElementById('nomePut').value,
            poder: document.getElementById('poderPut').value || null,
            alinhamento: document.getElementById('alinhamentoPut').value || null,
            genero: document.getElementById('generoPut').value || null,
            altura: parseFloat(document.getElementById('alturaPut').value) || null,
            peso: parseFloat(document.getElementById('pesoPut').value) || null
        };

        output.textContent = "Atualizando...";
        const res = await fetchWithAuth(`${baseUrl}/${id}`, {
            method: 'PUT',
            body: JSON.stringify(dto)
        });

        output.textContent = await res.text();
        if (res.ok) {
            setTimeout(() => {
                hideUpdateForm();
                refreshAllTables();
            }, 1500);
        }
    }
</script>
</body>
</html>